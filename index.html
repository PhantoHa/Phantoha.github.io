<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ZPL a PDF 4x6</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    textarea { width: 100%; height: 200px; font-family: monospace; font-size: 14px; }
    button { margin: 10px 5px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Convertir ZPL a PDF 4x6</h1>

  <textarea id="zplInput" placeholder="Pega aquí tu código ZPL..."></textarea><br>
  <button id="btnGenerar">Generar PDF desde ZPL</button>
  <a id="descargar" style="display:none;" download="zpl-4x6.pdf">Descargar PDF 4x6</a>

  <script>
    const DPI = 300;
    const PULGADA = 72;
    const widthInPoints = 4 * PULGADA;
    const heightInPoints = 6 * PULGADA;

    async function enviarZPLaLabelary(zpl) {
      const response = await fetch("https://api.labelary.com/v1/printers/8dpmm/labels/4x8/0/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: zpl
      });
    
      const contentType = response.headers.get("Content-Type");
    
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error de Labelary: ${errorText}`);
      }
    
      if (!contentType.includes("application/pdf")) {
        throw new Error("La respuesta no es un PDF. ¿ZPL inválido?");
      }
    
      return await response.blob(); // PDF blob válido
    }


    async function convertirPDFa4x6(blobPDF) {
      const arrayBuffer = await blobPDF.arrayBuffer();
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pdfDoc = await PDFLib.PDFDocument.create();

      for (let i = 0; i < pdf.numPages; i++) {
        const page = await pdf.getPage(i + 1);
        const viewport = page.getViewport({ scale: 2 });

        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext("2d");
        await page.render({ canvasContext: context, viewport }).promise;

        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        const imgBytes = await blob.arrayBuffer();
        const imgEmbed = await pdfDoc.embedPng(imgBytes);
        const scaledDims = imgEmbed.scaleToFit(widthInPoints, heightInPoints);

        const newPage = pdfDoc.addPage([widthInPoints, heightInPoints]);
        newPage.drawImage(imgEmbed, {
          x: (widthInPoints - scaledDims.width) / 2,
          y: (heightInPoints - scaledDims.height) / 2,
          width: scaledDims.width,
          height: scaledDims.height,
        });
      }

      const newPDFBytes = await pdfDoc.save();
      return new Blob([newPDFBytes], { type: 'application/pdf' });
    }

    document.getElementById("btnGenerar").addEventListener("click", async () => {
      const zpl = document.getElementById("zplInput").value.trim();
      if (!zpl) return alert("Escribe algún código ZPL primero.");

      try {
        const pdfOriginal = await enviarZPLaLabelary(zpl);
        const pdfConvertido = await convertirPDFa4x6(pdfOriginal);

        const url = URL.createObjectURL(pdfConvertido);
        const link = document.getElementById("descargar");
        link.href = url;
        link.style.display = "inline-block";
        link.textContent = "Descargar PDF 4x6";
      } catch (err) {
        console.error(err);
        alert("Ocurrió un error: " + err.message);        
      }
    });
  </script>
</body>
</html>
